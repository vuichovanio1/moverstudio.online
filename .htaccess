# ========================================
# MOVER Studio - moverstudio.online
# Optimized .htaccess for cPanel & Social Sharing
# ========================================

# Enable RewriteEngine
[cite_start]RewriteEngine On 

# ----------------------------------------
# 1. Force HTTPS (301 redirect)
# ----------------------------------------
[cite_start]RewriteCond %{HTTPS} off 
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301] 

# ----------------------------------------
# 2. Force www → non-www
# ----------------------------------------
[cite_start]RewriteCond %{HTTP_HOST} ^www\.moverstudio\.online$ [NC] 
RewriteRule ^ https://moverstudio.online%{REQUEST_URI} [L,R=301] 

# ----------------------------------------
# 3. Custom Error Pages
# ----------------------------------------
[cite_start]ErrorDocument 404 /404.html 

# ----------------------------------------
# 4. Security Headers (Social Media Friendly)
# ----------------------------------------
[cite_start]<IfModule mod_headers.c> 
  # CSP: Разрешаваме img-src https: за Facebook/Messenger ботовете
  [cite_start]Header set Content-Security-Policy "default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'" [cite: 2, 3]

  # Предотвратява MIME type sniffing
  [cite_start]Header set X-Content-Type-Options "nosniff" [cite: 4]

  # Защита от clickjacking
  [cite_start]Header set X-Frame-Options "DENY" [cite: 4]

  # HSTS
  [cite_start]Header set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" [cite: 4, 5]

  # Cross-Origin Policies - Оправени за Messenger преглед
  Header set Cross-Origin-Opener-Policy "unsafe-none"
  Header unset Cross-Origin-Embedder-Policy

  # Контрол на референтната информация
  [cite_start]Header set Referrer-Policy "strict-origin-when-cross-origin" [cite: 4]

  # Фикс за грешка 206 (Partial Content)
  Header set Accept-Ranges none
  
  # DNS Prefetch
  [cite_start]Header set X-DNS-Prefetch-Control "on" [cite: 4]
</IfModule> 

# ----------------------------------------
# 5. MIME Types
# ----------------------------------------
[cite_start]<IfModule mod_mime.c> [cite: 5]
  [cite_start]AddType text/html .html [cite: 5]
  [cite_start]AddType text/css .css [cite: 5]
  [cite_start]AddType text/xml .xml [cite: 5]
  [cite_start]AddType application/javascript .js [cite: 5]
  [cite_start]AddType image/svg+xml .svg [cite: 5]
  [cite_start]AddType image/webp .webp [cite: 5]
  [cite_start]AddType image/png .png [cite: 5]
  [cite_start]AddType image/x-icon .ico [cite: 5]
</IfModule> [cite: 5]

# ----------------------------------------
# 6. Compression (Gzip)
# ----------------------------------------
[cite_start]<IfModule mod_deflate.c> [cite: 5]
  [cite_start]AddOutputFilterByType DEFLATE text/html [cite: 5]
  [cite_start]AddOutputFilterByType DEFLATE text/css [cite: 5]
  [cite_start]AddOutputFilterByType DEFLATE text/xml [cite: 6]
  [cite_start]AddOutputFilterByType DEFLATE text/javascript [cite: 6]
  [cite_start]AddOutputFilterByType DEFLATE application/javascript [cite: 6]
  [cite_start]AddOutputFilterByType DEFLATE application/json [cite: 6]
  [cite_start]AddOutputFilterByType DEFLATE application/xml [cite: 6]
  [cite_start]AddOutputFilterByType DEFLATE image/svg+xml [cite: 6]
</IfModule> [cite: 5]

# ----------------------------------------
# 7. Browser Caching
# ----------------------------------------
[cite_start]<IfModule mod_expires.c> [cite: 6]
  [cite_start]ExpiresActive On [cite: 6]
  [cite_start]ExpiresByType text/html "access plus 1 day" [cite: 6]
  [cite_start]ExpiresByType text/css "access plus 1 year" [cite: 6]
  [cite_start]ExpiresByType application/javascript "access plus 1 year" [cite: 6]
  [cite_start]ExpiresByType image/svg+xml "access plus 1 year" [cite: 6]
  [cite_start]ExpiresByType image/png "access plus 1 year" [cite: 6]
  [cite_start]ExpiresByType image/webp "access plus 1 year" [cite: 6]
  [cite_start]ExpiresByType image/x-icon "access plus 1 year" [cite: 6]
</IfModule> [cite: 6]

# ----------------------------------------
# 8. ETag (използваме само Expires за по-бърз PageSpeed)
# ----------------------------------------
[cite_start]<IfModule mod_headers.c> [cite: 7]
  [cite_start]Header unset ETag [cite: 7]
</IfModule> [cite: 7]
FileETag None [cite: 7]

# ----------------------------------------
# 9. Забрана на листване на директории
# ----------------------------------------
[cite_start]Options -Indexes [cite: 7]

# ----------------------------------------
# 10. Блокиране на достъп до системни файлове
# ----------------------------------------
[cite_start]<FilesMatch "(^\.htaccess|_headers|\.git)"> [cite: 7]
  [cite_start]<IfModule mod_authz_core.c> [cite: 7]
    [cite_start]Require all denied [cite: 7]
  [cite_start]</IfModule> [cite: 7]
</FilesMatch> [cite: 7]

# ----------------------------------------
# 11. Фикс за началната страница и блога
# ----------------------------------------

# Уверяваме се, че коренът зарежда главния файл
DirectoryIndex index.html

# Пренасочваме /blog към /blog/ само ако е изписано точно така
RewriteCond %{REQUEST_URI} ^/blog$ [NC]
RewriteRule ^ /blog/ [L,R=301]